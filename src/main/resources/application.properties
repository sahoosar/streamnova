# ============================================================================
# Application
# ============================================================================
# Name used in logs and transaction events.
spring.application.name=StreamNova

# ============================================================================
# Pipeline profile (choose DB type and environment)
# ============================================================================
# Single DB: postgres (default) | oracle | postgres-sit | oracle-uat | etc.
# Both DBs:  postgres, oracle  (invokes application-postgres + application-oracle; datasources created in parallel)
# Example: --spring.profiles.active=postgres,oracle  when streamnova.statistics.supported-source-types=postgres,oracle
#
# Multiple profiles selected (see MULTI_PROFILE_HANDLING.md):
#   - postgres,oracle: set supported-source-types=postgres,oracle; both YAMLs merge. Set streamnova.pipeline.default-source=postgres (or oracle) to choose default.
#   - postgres,postgres-light: postgres loads config file; postgres-light only sets scenario=light (no conflict).
#   - postgres,postgres-sit: environment overrides (SIT URL/user/password); one env profile at a time.
spring.profiles.active=postgres

# Where to change connection/config per DB and environment:
#   Postgres dev:     application-postgres.properties + postgre_pipeline_config.yml
#   Postgres SIT:     application-postgres-sit.properties (overrides jdbc-url, user, password, table)
#   Postgres UAT:     application-postgres-uat.properties
#   Postgres PROD:    application-postgres-prod.properties
#   Oracle dev:       application-oracle.properties + oracle_pipeline_config.yml
#   Oracle SIT:       application-oracle-sit.properties
#   Oracle UAT:       application-oracle-uat.properties
#   Oracle PROD:      application-oracle-prod.properties
# Shared defaults (pool, sharding, fetch size, etc.): postgre_pipeline_config.yml / oracle_pipeline_config.yml
# Password: no hardcoded passwords. Set POSTGRES_PASSWORD / ORACLE_PASSWORD env vars; pipeline YAML uses ${POSTGRES_PASSWORD}. streamnova.pipeline.config-file is required (no in-memory config).
#
# Different users / machine types: PRODUCTION approach (see PIPELINE_CONFIG_PRODUCTION.md):
#   One YAML with pipeline.config.scenarios (light/heavy/prod). Set STREAMNOVA_PIPELINE_SCENARIO in the deployment
#   (K8s, Dataflow, etc.); use ${POSTGRES_PASSWORD} etc. for secrets. Do not rely on defaultScenario in prod.

# Context path (e.g. when behind a proxy at /streamnova). Use /api/pipeline/table-statistics without this prefix when context-path is empty.
server.servlet.context-path=/streamnova

# Disable DevTools property-defaults log message (optional)
spring.devtools.add-properties=false

# ============================================================================
# Actuator Configuration - Metrics & Monitoring
# ============================================================================
# Enable Actuator endpoints
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.endpoint.health.show-details=when-authorized
management.endpoint.metrics.enabled=true
management.endpoint.prometheus.enabled=true

# Metrics configuration
management.metrics.export.prometheus.enabled=true
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.sla.http.server.requests=100ms,500ms,1s,2s,5s

# ============================================================================
# Logging Configuration
# ============================================================================
# Root logger
logging.level.root=INFO

# Your package logs (debug if you want more)
logging.level.com.di.streamnova=INFO

# Named loggers used in your helpers
logging.level.DLQ=INFO
logging.level.VALID=INFO

# ============================================================================
# Guardrails
# ============================================================================
# Allowed machine types at recommend/execute. Comma-separated; exact or family prefix (e.g. n2 = n2-*).
# When set, only these types are allowed. Empty = no restriction.
streamnova.guardrails.allowed-machine-types=n2d-standard-2,n2-standard-2,n2d-standard-4,c3-standard-4,n2-standard-4,n2d-standard-8,c3-standard-8,n2-standard-8,n2d-standard-16,n2-standard-16
# Optional: max duration (sec) and max cost (USD) when client omits them. Uncomment and set to enable.
#streamnova.guardrails.max-duration-sec=
#streamnova.guardrails.max-cost-usd=

# ============================================================================
# Estimator (duration and cost estimation)
# ============================================================================
# USD per vCPU-hour by machine family (cost estimation). Override for region or custom pricing.
streamnova.estimator.usd-per-vcpu-hour.n2=0.031
streamnova.estimator.usd-per-vcpu-hour.n2d=0.027
streamnova.estimator.usd-per-vcpu-hour.c3=0.035
# Machine family detection: ordered prefixes (first match wins; put n2d before n2). Default when no prefix matches.
streamnova.estimator.machine-family-prefixes=n2d,n2,c3
streamnova.estimator.machine-family-default=n2
# Display: USD to GBP rate for cost in GBP (e.g. 0.79).
streamnova.estimator.usd-to-gbp=0.79
# Throughput: default MB/s when no warm-up or history. Fallback duration (sec) when effective throughput is 0.
streamnova.estimator.default-throughput-mb-per-sec=50
streamnova.estimator.fallback-duration-sec=3600
# Learning: max past runs for duration/cost corrections. Max past runs for throughput history fallback.
streamnova.estimator.learning-signals-limit=100
streamnova.estimator.throughput-history-limit=10
# Caps (MB/s): source by DB type (postgres/oracle), sink by load pattern (bq-direct/gcs-bq), CPU = per-vCPU rate × workers × vCPUs.
streamnova.estimator.source-cap.postgres=500
streamnova.estimator.source-cap.oracle=80
streamnova.estimator.sink-cap.bq-direct=100
streamnova.estimator.sink-cap.gcs-bq=400
streamnova.estimator.cpu-cap-mb-per-sec-per-vcpu=60

# ============================================================================
# Recommend API (profile → candidates → estimate → recommend)
# ============================================================================
# Max candidates to generate and score. Lower = faster response; higher = more options.
streamnova.recommend.max-candidates=4
# Max worker count per candidate (1, 2, 3, … up to this). Increase for more scaling options.
streamnova.recommend.max-workers=4
# Safety cap on workers: effective max = min(max-workers, max-workers-cap).
streamnova.recommend.max-workers-cap=8
# Fallback pool size when deriving from machine type (pool not in config). Should match pipeline_config.yml fallbackPoolSize.
streamnova.recommend.fallback-pool-size=8

# ============================================================================
# Execution planner (candidate generation)
# ============================================================================
# Machine types for candidates (order = evaluation order). Empty = built-in default (n2d, n2, c3). Add/reorder without code change.
streamnova.execution-planner.machine-ladder.types=n2d-standard-4,n2d-standard-8,n2d-standard-16,n2-standard-4,n2-standard-8,n2-standard-16,c3-standard-4,c3-standard-8,c3-standard-16

# ============================================================================
# Shard planner
# ============================================================================
# Max shards when pool size not provided (e.g. tests). When pool from pipeline is passed, that value is used as cap.
streamnova.shardplanner.max-shards-cap=16
# Fallback shard count when vCPUs cannot be parsed from machine type.
streamnova.shardplanner.fallback-shards-when-no-vcpus=4
# Machine-type optimizer: record-count targets when data size (MB) not available. high-cpu / high-mem / standard = target records per shard.
streamnova.shardplanner.high-cpu-target-records-per-shard=20000
streamnova.shardplanner.high-mem-target-records-per-shard=100000
streamnova.shardplanner.standard-target-records-per-shard=50000
# Min-shards: max records per shard (fallback) or max MB per shard (when size available).
streamnova.shardplanner.fallback-max-records-per-shard=200000
streamnova.shardplanner.max-mb-per-shard=500
# Pool headroom: shard count capped at pool-size × this ratio (e.g. 0.8 = 80%).
streamnova.shardplanner.pool-headroom-ratio=0.8

# ============================================================================
# Profiler (table stats and warm-up)
# ============================================================================
# Warm-up read: number of rows to sample and fetch size for throughput discovery.
streamnova.profiler.warm-up-rows=5000
streamnova.profiler.warm-up-fetch-size=1000

# ============================================================================
# Capacity (execute admission and rate limiting)
# ============================================================================
# Message and Retry-After (sec) when request cannot be processed (e.g. 429).
streamnova.capacity.resource-limited-message=Due to minimal resources, the request cannot be processed. Please retry later.
streamnova.capacity.retry-after-sec=60
# Max shards (connections) in use. 0 = derive from pipeline_config maximumPoolSize. Set >0 to override.
streamnova.capacity.max-shards=0
# Message when execute is rejected (required shards > available).
streamnova.capacity.shards-not-available-message=Not enough shards available; please wait for full availability.
# Recommend concurrency: max concurrent recommend requests; 0 = no limit. Timeout (sec) to wait for a slot before 429.
streamnova.recommend.max-concurrent-requests=0
streamnova.recommend.concurrent-request-acquire-timeout-sec=5

# ============================================================================
# Statistics / pipeline config
# ============================================================================
# Source types for table statistics and startup datasource creation. Use spring.profiles.active=postgres,oracle when both.
# When set to "postgres, oracle" use spring.profiles.active=postgres,oracle so application-postgres.properties
# and application-oracle.properties are both invoked; configs merge and datasources are created in parallel at startup.
# Use ?source=postgres or ?source=oracle in /api/pipeline/table-statistics and /api/pipeline/config.
streamnova.statistics.supported-source-types=postgres